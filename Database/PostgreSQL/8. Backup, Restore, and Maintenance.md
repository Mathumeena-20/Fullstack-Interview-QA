
## 🗂️ **1️⃣ How do you back up a PostgreSQL database?**

PostgreSQL provides multiple backup methods depending on use case:

### ✅ **A. Using `pg_dump` (Logical Backup)**

Used for backing up a single database in a portable SQL or binary format.

#### 📘 **Syntax:**

```bash
pg_dump -U username -d database_name -f backup_file.sql
```

#### 💡 **Example:**

```bash
pg_dump -U postgres -d company_db -f company_backup.sql
```

This will create a **SQL file** containing all schema + data (like `CREATE TABLE`, `INSERT` statements).

---

### ✅ **B. Custom Format Backup**

For compressed or selective restore (recommended in production):

```bash
pg_dump -U postgres -F c -b -v -f company_backup.dump company_db
```

* `-F c` → custom format
* `-b` → include large objects (BLOBs)
* `-v` → verbose

---

### ✅ **C. Full Cluster Backup (All Databases)**

Use `pg_dumpall` to back up **roles + all databases**:

```bash
pg_dumpall -U postgres -f full_backup.sql
```

---

### ✅ **D. Physical Backup (File System Level)**

For **large or production servers**, use:

* `pg_basebackup`
* or copy data directory when the DB is offline.

#### Example:

```bash
pg_basebackup -U postgres -D /path/to/backup -Ft -z -P
```

* `-Ft` → tar format
* `-z` → compress
* `-P` → progress bar

---

## ♻️ **2️⃣ How do you restore a database from a backup file?**

It depends on the **backup format** you used.

---

### ✅ **A. Restore from SQL file (`pg_dump`)**

```bash
psql -U postgres -d new_db -f company_backup.sql
```

This replays all SQL commands to recreate tables and data.

---

### ✅ **B. Restore from Custom Format (`.dump`)**

Use `pg_restore`:

```bash
pg_restore -U postgres -d new_db -v company_backup.dump
```

Or create DB first:

```bash
createdb -U postgres new_db
pg_restore -U postgres -d new_db company_backup.dump
```

---

### ✅ **C. Restore all databases (`pg_dumpall`)**

```bash
psql -U postgres -f full_backup.sql
```

---

### ✅ **D. Physical Restore (for base backups)**

1. Stop PostgreSQL server.
2. Replace data directory with backup directory.
3. Restart the PostgreSQL service.

---

## ⚖️ **3️⃣ What is the difference between `pg_dump` and `pg_dumpall`?**

| Feature               | **pg_dump**              | **pg_dumpall**        |
| --------------------- | ------------------------ | --------------------- |
| Scope                 | Single database          | All databases + roles |
| Backup Type           | Logical (SQL/custom/tar) | SQL script only       |
| Includes Roles/Users? | ❌ No                     | ✅ Yes                 |
| Restore Tool          | `pg_restore` or `psql`   | `psql` only           |
| Use Case              | Backup one DB            | Full cluster backup   |

---

### 💡 Example:

```bash
pg_dump -U postgres -d company_db -f company.sql     # one database
pg_dumpall -U postgres -f all_dbs.sql                # entire cluster
```

---

## 📜 **4️⃣ What is WAL (Write-Ahead Logging)?**

### ✅ **Definition:**

WAL = **Write-Ahead Log** — a mechanism that ensures **data integrity**.

Every change (INSERT, UPDATE, DELETE) is first written to the **WAL file** before being applied to the actual database.

---

### 💡 **Why WAL is important:**

1. Ensures **durability** (from ACID).
2. Helps **recover from crashes**.
3. Enables **replication** and **point-in-time recovery (PITR)**.

---

### 🧠 **Example (Internally):**

When you update a record:

```sql
UPDATE employees SET salary = 60000 WHERE id = 5;
```

* PostgreSQL first logs this change in the WAL segment (`pg_wal/` directory).
* If the server crashes, PostgreSQL replays the WAL file to restore the consistent state.

---

### 🧩 **WAL Files Location:**

Stored in the **data directory**:

```
/var/lib/postgresql/15/main/pg_wal/
```

---

### ⚙️ **WAL Settings (postgresql.conf):**

```ini
wal_level = replica
archive_mode = on
archive_command = 'cp %p /mnt/backup/%f'
```

🧠 This setup enables **archiving and replication**.

---

## 📈 **5️⃣ How do you monitor database performance?**

You can monitor PostgreSQL performance using **system views, tools, and extensions**.

---

### ✅ **A. Built-in Views**

1. **pg_stat_activity** — current queries

   ```sql
   SELECT pid, usename, datname, state, query FROM pg_stat_activity;
   ```

2. **pg_stat_database** — stats per database

   ```sql
   SELECT datname, numbackends, xact_commit, xact_rollback, blks_hit, blks_read
   FROM pg_stat_database;
   ```

3. **pg_stat_user_tables** — table-level I/O stats

   ```sql
   SELECT relname, seq_scan, idx_scan, n_tup_ins, n_tup_upd, n_tup_del
   FROM pg_stat_user_tables;
   ```

---

### ✅ **B. Analyze Query Plans**

Use `EXPLAIN` and `EXPLAIN ANALYZE`:

```sql
EXPLAIN ANALYZE SELECT * FROM employees WHERE salary > 50000;
```

→ Shows cost, index usage, and performance bottlenecks.

---

### ✅ **C. Check Locks**

```sql
SELECT * FROM pg_locks;
```

→ Detects blocking queries or deadlocks.

---

### ✅ **D. Check Table Bloat / Vacuum Info**

```sql
SELECT relname, n_dead_tup FROM pg_stat_user_tables WHERE n_dead_tup > 0;
```

---

### ✅ **E. Extensions for Monitoring**

* `pg_stat_statements` → Track slow or frequent queries.

  ```sql
  CREATE EXTENSION pg_stat_statements;
  SELECT * FROM pg_stat_statements ORDER BY total_exec_time DESC LIMIT 5;
  ```
* Tools: **pgAdmin**, **pgBadger**, **Prometheus + Grafana**, **pganalyze**.

---

### ✅ **F. Maintenance Commands**

| Command      | Description                                    |
| ------------ | ---------------------------------------------- |
| `VACUUM`     | Reclaims storage space from deleted tuples     |
| `ANALYZE`    | Updates table statistics for the query planner |
| `REINDEX`    | Rebuilds corrupted or bloated indexes          |
| `CHECKPOINT` | Forces writing dirty pages to disk             |

---

### 💡 Example:

```sql
VACUUM ANALYZE employees;
```

→ Cleans up dead tuples and updates planner statistics.

---

## ✅ **Summary Table**

| Topic                      | Command / Concept              | Purpose                      |
| -------------------------- | ------------------------------ | ---------------------------- |
| **Backup (DB)**            | `pg_dump`                      | Backup single DB             |
| **Backup (Cluster)**       | `pg_dumpall`                   | Backup all DBs + roles       |
| **Restore SQL**            | `psql -f`                      | Restore from .sql            |
| **Restore Custom**         | `pg_restore`                   | Restore from .dump           |
| **WAL**                    | Write-Ahead Logging            | Crash recovery & replication |
| **Performance Monitoring** | `pg_stat_activity`, `EXPLAIN`  | Find slow queries            |
| **Maintenance**            | `VACUUM`, `ANALYZE`, `REINDEX` | Optimize DB health           |

---

### 🧠 **Interview Tip:**

If asked:

> “How do you ensure high availability and disaster recovery in PostgreSQL?”

✅ Say:

> “We use `pg_basebackup` + WAL archiving for point-in-time recovery and set up streaming replication for high availability.”

